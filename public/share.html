<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processando arquivo...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      color: #e4e4eb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .loading {
      text-align: center;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid #1a1a26;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="loading">
    <div class="spinner"></div>
    <p>Processando arquivo compartilhado...</p>
  </div>

  <script>
    /**
     * Handle files received via Web Share Target API
     * 
     * When the PWA receives a shared file, the browser sends a POST request
     * to this page with the file data as multipart/form-data.
     */
    async function handleSharedFile() {
      try {
        // Get the file from the form data that was posted
        const formData = await getFormData();
        
        if (!formData) {
          // No form data means user navigated here directly
          window.location.href = '/';
          return;
        }

        const file = formData.get('file');
        
        if (!file || !(file instanceof File)) {
          throw new Error('No file received');
        }

        // Read file content
        const content = await file.text();
        
        // Store in sessionStorage for the main app to pick up
        sessionStorage.setItem('sharedFileContent', content);
        sessionStorage.setItem('sharedFileName', file.name);
        
        // Redirect to main app
        window.location.href = '/?shared=true';
        
      } catch (error) {
        console.error('Error handling shared file:', error);
        alert('Erro ao processar arquivo. Por favor, tente novamente.');
        window.location.href = '/';
      }
    }

    async function getFormData() {
      // Try to get form data from the page load
      // This is set by the service worker or browser when handling share target
      
      // Check if we're a POST request with form data
      if (window.location.search.includes('shared')) {
        return null;
      }

      // Try to read from the service worker cache
      const cache = await caches.open('share-target-cache');
      const response = await cache.match('/share-target-data');
      
      if (response) {
        await cache.delete('/share-target-data');
        return await response.formData();
      }

      return null;
    }

    // Alternative: Handle via service worker message
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
      navigator.serviceWorker.addEventListener('message', async (event) => {
        if (event.data && event.data.type === 'SHARE_TARGET_FILE') {
          const { file } = event.data;
          sessionStorage.setItem('sharedFileContent', file.content);
          sessionStorage.setItem('sharedFileName', file.name);
          window.location.href = '/?shared=true';
        }
      });
    }

    // Run on page load
    handleSharedFile();
  </script>
</body>
</html>

